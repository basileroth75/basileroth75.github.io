<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krill & Fishing Events Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map-wrapper {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border: none;
            border-radius: 0;
            overflow: hidden;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            z-index: 999; 
        }
        
        #map { width: 100%; height: 100%; z-index: 1; }

        .custom-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 6px 10px;
            color: #333;
            font-size: 12px;
            line-height: 1.4;
        }
        .custom-tooltip b { color: #555; }
        .tooltip-title { font-weight: bold; font-size: 13px; margin-bottom: 4px; border-bottom: 1px solid; padding-bottom: 2px;}

        #controls-panel { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 12px; 
            border-radius: 6px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            font-size: 11px; 
            z-index: 1000; 
            width: 240px; 
            max-height: 90%; 
            overflow-y: auto;
        }
        
        .legend-section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #ddd;
        }
        .legend-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .legend-title { font-weight: bold; font-size: 13px; margin-bottom: 8px; color: #2c3e50;}
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; } 

        .legend-color { width: 12px; height: 12px; margin-right: 6px; border-radius: 2px; border: 1px solid #999; flex-shrink: 0;}
        .legend-line { width: 12px; height: 2px; margin-right: 6px; flex-shrink: 0;}
        
        .input-group { display: flex; flex-direction: column; margin-top: 5px; gap: 4px; }
        .input-group input, .input-group select { padding: 3px 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; box-sizing: border-box;}
        .action-btn { margin-top: 6px; width: 100%; padding: 5px; background: #2c3e50; color: white; border: none; border-radius: 3px; cursor: pointer; transition: 0.2s; font-size: 11px;}
        .action-btn:hover { background: #34495e; }
        .count-text { margin-top: 4px; font-size: 0.9em; color: #666; font-style: italic;}
    </style>
</head>
<body>

<div id="map-wrapper">
    <div id="map"></div>

    <div id="controls-panel">
        
        <div class="legend-section">
            <div class="legend-title">üõ°Ô∏è Protection Zones</div>
            <div id="dynamic-zone-legend"></div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(144, 238, 144, 0.5); border: 1px solid #2ca25f;"></div>
                <span>CCAMLR MPAs (WMS)</span>
            </div>
        </div>

        <div class="legend-section">
            <div class="legend-title">üö¢ Fishing Events & Filters</div>
            
            <div class="legend-item">
                <div class="legend-line" style="background: #377eb8; height: 3px;"></div>
                <span>Antarctic Endurance</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #e41a1c; height: 3px;"></div>
                <span>Saga Sea</span>
            </div>

            <div class="input-group" style="margin-top: 10px;">
                <label>Date From: <input type="date" id="start-date" value="2020-01-01"></label>
                <label>Date To: <input type="date" id="end-date"></label>
                
                <label>Month From: 
                    <select id="start-month">
                        <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                        <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                        <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                    </select>
                </label>
                <label>Month To: 
                    <select id="end-month">
                        <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                        <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                        <option value="9">October</option><option value="10">November</option><option value="11" selected>December</option>
                    </select>
                </label>

                <button id="apply-track-filter" class="action-btn">Apply Static Filter</button>
                <button id="play-animation" class="action-btn" style="background: #27ae60; margin-top: 8px;">‚ñ∂ Play Time-Lapse</button>
                <div id="animation-date-display" class="count-text" style="font-weight: bold; color: #e74c3c; text-align: center; margin-top: 6px;"></div>
            </div>
            <div id="track-count" class="count-text"></div>
        </div>

        <div class="legend-section">
            <div class="legend-title">üêü Krill Density</div>
            
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(to right, #74add1, #e0f3f8, #fee090, #f46d43); border: 1px solid #999;"></div>
                <span>Density Gradient</span>
            </div>

            <div class="input-group" style="margin-top: 10px;">
                <label>Year From: <input type="number" id="krill-start-year"></label>
                <label>Year To: <input type="number" id="krill-end-year"></label>
                <button id="apply-krill-filter" class="action-btn">Apply Krill Filter</button>
            </div>
            <div id="krill-count" class="count-text"></div>
        </div>

    </div>
</div>

<script>
    const FORBIDDEN_COLUMN_NAME = "protected";

    const map = L.map('map', { zoomControl: false }).setView([-60, -55], 5);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 18
    }).addTo(map);

    const zonesLayer = L.layerGroup().addTo(map); 
    const tracks1Layer = L.layerGroup().addTo(map); 
    const tracks2Layer = L.layerGroup().addTo(map); 
    const krillHeatmapLayer = L.layerGroup().addTo(map);

    // CCAMLR MPA WMS Layer
    const mpaWMSLayer = L.tileLayer.wms("https://gis.ccamlr.org:443/geoserver/gis/wms", {
        layers: 'gis:mpas',
        format: 'image/png',
        transparent: true,
        version: '1.1.1',
        attribution: '<a href="https://www.ccamlr.org/en/science/marine-protected-areas-mpas">CCAMLR MPAs</a>'
    }).addTo(map);

    const overlayMaps = {
        "üõ°Ô∏è Protection Zones": zonesLayer,
        "üåä CCAMLR MPAs": mpaWMSLayer,
        "üö¢ Antarctic Endurance": tracks1Layer,
        "üö¢ Saga Sea": tracks2Layer,
        "üêü Krill Heatmap": krillHeatmapLayer
    };
    L.control.layers(null, overlayMaps, { collapsed: false, position: 'topright' }).addTo(map);

    let allTracksData = []; 
    let allKrillData = [];
    
    // Animation Global Variables
    let animationInterval = null;
    let currentSimDate = null;

    // --- CSV URLS ---
    const tracksCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/ANTARCTIC_ENDURANCE.csv";
    const tracks2CsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/SAGASEA.csv";
    const zonesCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/domaine1-Zone_de_protection_general.csv";
    const zonesSaisonCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/domaine1-Zone_de_protection_saison.csv";
    const krillCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/processed_krill.csv";

    Promise.all([
        d3.csv(tracksCsvUrl),
        d3.csv(tracks2CsvUrl).catch(() => []), 
        d3.dsv(";", zonesCsvUrl),
        d3.dsv(";", zonesSaisonCsvUrl),
        d3.csv(krillCsvUrl)
    ]).then(([tracks1Data, tracks2Data, zonesData, zonesSaisonData, krillData]) => {

        // --- ZONES & DYNAMIC LEGEND ---
        const allZonesData = [...zonesData, ...zonesSaisonData];
        const uniquePeriods = Array.from(new Set(allZonesData.map(d => 
            d[FORBIDDEN_COLUMN_NAME] ? d[FORBIDDEN_COLUMN_NAME].trim() : 'Not Specified'
        )));        
        const zoneColorScale = d3.scaleOrdinal(d3.schemeTableau10).domain(uniquePeriods);

        const legendContainer = document.getElementById('dynamic-zone-legend');
        uniquePeriods.forEach(period => {
            const color = zoneColorScale(period);
            const borderColor = d3.rgb(color).darker(0.5);
            legendContainer.innerHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${color}; opacity: 0.6; border-color: ${borderColor};"></div>
                    <span> ${period}</span>
                </div>
            `;
        });

        function renderZoneGroup(data) {
            d3.group(data, d => d.zone_id).forEach((points, zoneId) => {
                points.sort((a, b) => +a.seq - +b.seq);
                const rawPeriod = points[0][FORBIDDEN_COLUMN_NAME];
                const period = rawPeriod ? rawPeriod.trim() : 'Not Specified';
                const fillColor = zoneColorScale(period);
                const borderColor = d3.rgb(fillColor).darker(0.5);
                const latlngs = points.map(p => [+p.lat, +p.lon]);

                L.polygon(latlngs, {
                    color: borderColor, fillColor: fillColor,
                    weight: 2, dashArray: '4, 4', fillOpacity: 0.4
                }).bindTooltip(`
                    <div class="custom-tooltip">
                        <div class="tooltip-title" style="border-color: ${borderColor}">Protection Zone</div>
                        <b>ID:</b> ${zoneId}<br>
                        <b>Forbidden:</b> ${period}
                    </div>
                `, { sticky: true }).addTo(zonesLayer);
            });
        }

        renderZoneGroup(zonesData);
        renderZoneGroup(zonesSaisonData);

        // --- TRACKS (FISHING EVENTS) ---
        tracks1Data.forEach(d => { 
            d.boatSource = "Antarctic Endurance"; 
            d.dateObj = new Date(d.start); 
            d.endDateObj = new Date(d.end); 
            d.lat = parseFloat(d.latitude); 
            d.lon = parseFloat(d.longitude); 
            d.seg_id = d.voyage; 
        });
        
        tracks2Data.forEach(d => { 
            d.boatSource = "Saga Sea"; 
            d.dateObj = new Date(d.start); 
            d.endDateObj = new Date(d.end); 
            d.lat = parseFloat(d.latitude); 
            d.lon = parseFloat(d.longitude); 
            d.seg_id = d.voyage; 
        });
        
        allTracksData = [...tracks1Data, ...tracks2Data];

        let maxDate = allTracksData.length > 0 ? d3.max(allTracksData, d => d.dateObj) : new Date();
        document.getElementById('end-date').value = maxDate.toISOString().split('T')[0];

        renderTracks(); 

        // --- KRILL ---
        let krillMinYear = 3000, krillMaxYear = 0;
        krillData.forEach(d => {
            d.yearNum = parseInt(d.year);
            d.lat = parseFloat(d.dcmlLtt); 
            d.lon = parseFloat(d.dcmlLng); 
            
            if (!isNaN(d.yearNum)) {
                if (d.yearNum < krillMinYear) krillMinYear = d.yearNum;
                if (d.yearNum > krillMaxYear) krillMaxYear = d.yearNum;
            }
        });
        
        allKrillData = krillData.filter(d => !isNaN(d.lat) && !isNaN(d.lon));
        
        if (krillMinYear <= krillMaxYear) {
            document.getElementById('krill-start-year').value = krillMinYear;
            document.getElementById('krill-end-year').value = krillMaxYear;
            document.getElementById('krill-start-year').min = krillMinYear;
            document.getElementById('krill-end-year').max = krillMaxYear;
        }

        renderKrillHeatmap(); 

    }).catch(error => {
        console.error("Error loading data:", error);
    });

    // --- STATIC TRACK RENDERING ---
    function renderTracks() {
        // Stop animation if user manually clicks the static filter button
        stopAnimation();

        tracks1Layer.clearLayers();
        tracks2Layer.clearLayers();
        
        const start = new Date(document.getElementById('start-date').value);
        const end = new Date(document.getElementById('end-date').value);
        end.setHours(23, 59, 59); 

        const startMonth = parseInt(document.getElementById('start-month').value);
        const endMonth = parseInt(document.getElementById('end-month').value);

        const filteredData = allTracksData.filter(d => {
            if (!d.dateObj || isNaN(d.dateObj)) return false;
            const isRightTime = d.dateObj >= start && d.dateObj <= end;
            const m = d.dateObj.getMonth();
            let isRightMonth = (startMonth <= endMonth) ? (m >= startMonth && m <= endMonth) : (m >= startMonth || m <= endMonth);
            return isRightTime && isRightMonth;
        });

        document.getElementById('track-count').innerText = `Displaying ${filteredData.length} static points`;
        drawTrackData(filteredData, true); // true = draw static points
    }

    // --- ANIMATION LOGIC ---
    function stopAnimation() {
        if (animationInterval) {
            clearInterval(animationInterval);
            animationInterval = null;
        }
        document.getElementById('play-animation').innerText = "‚ñ∂ Play Time-Lapse";
        document.getElementById('play-animation').style.background = "#27ae60";
        document.getElementById('animation-date-display').innerText = "";
    }

    function toggleAnimation() {
        const btn = document.getElementById('play-animation');
        const endSimDate = new Date(document.getElementById('end-date').value);
        endSimDate.setHours(23, 59, 59);

        if (animationInterval) {
            // Pause the animation
            clearInterval(animationInterval);
            animationInterval = null;
            btn.innerText = "‚ñ∂ Resume Animation";
            btn.style.background = "#f39c12"; // Orange for paused
        } else {
            // Play or Resume
            if (!currentSimDate || currentSimDate > endSimDate) {
                currentSimDate = new Date(document.getElementById('start-date').value);
            }
            
            btn.innerText = "‚è∏ Pause Animation";
            btn.style.background = "#e74c3c"; // Red for active
            
            // Loop that ticks forward in time
            animationInterval = setInterval(() => {
                currentSimDate.setDate(currentSimDate.getDate() + 1); // Advance by 1 day per frame

                if (currentSimDate > endSimDate) {
                    stopAnimation();
                    document.getElementById('animation-date-display').innerText = "Animation Finished";
                    return;
                }

                document.getElementById('animation-date-display').innerText = `Simulated Date: ${currentSimDate.toISOString().split('T')[0]}`;
                renderAnimationFrame();
            }, 100); // 100 milliseconds per frame
        }
    }

    function renderAnimationFrame() {
        tracks1Layer.clearLayers();
        tracks2Layer.clearLayers();

        const startMonth = parseInt(document.getElementById('start-month').value);
        const endMonth = parseInt(document.getElementById('end-month').value);

        // Filter data UP TO the current simulation date
        const filteredTimelineData = allTracksData.filter(d => {
            if (!d.dateObj || isNaN(d.dateObj)) return false;
            
            const isBeforeSimDate = d.dateObj >= new Date(document.getElementById('start-date').value) && d.dateObj <= currentSimDate;
            const m = d.dateObj.getMonth();
            let isRightMonth = (startMonth <= endMonth) ? (m >= startMonth && m <= endMonth) : (m >= startMonth || m <= endMonth);

            return isBeforeSimDate && isRightMonth;
        });

        // Update the count text
        document.getElementById('track-count').innerText = `Tracking ${filteredTimelineData.length} points over time`;

        // Draw the tracks in animation mode (false = don't draw static dots everywhere)
        drawTrackData(filteredTimelineData, false); 
    }

    // --- REUSABLE DRAWING FUNCTION ---
    function drawTrackData(dataToDraw, isStatic) {
        const tracksGrouped = d3.group(dataToDraw, d => d.boatSource, d => d.seg_id);
        const boatColorScale = d3.scaleOrdinal().domain(["Antarctic Endurance", "Saga Sea"]).range(["#377eb8", "#e41a1c"]); 

        tracksGrouped.forEach((segments, boatSource) => {
            const baseColor = boatColorScale(boatSource);
            const targetLayer = boatSource === "Antarctic Endurance" ? tracks1Layer : tracks2Layer;

            segments.forEach((points, segId) => {
                points.sort((a, b) => a.dateObj - b.dateObj); 
                const latlngs = points.map(p => [+p.lat, +p.lon]);

                // Draw connecting line
                if (latlngs.length > 1) {
                    L.polyline(latlngs, { color: baseColor, weight: 1.5, opacity: 0.5, dashArray: '4, 4' }).addTo(targetLayer);
                }

                if (isStatic) {
                    // Draw ALL points (Static Mode)
                    points.forEach(d => {
                        L.circleMarker([+d.lat, +d.lon], {
                            radius: 4, fillColor: baseColor, color: "#fff", weight: 1, fillOpacity: 0.9
                        }).bindTooltip(`
                            <div class="custom-tooltip">
                                <div class="tooltip-title" style="border-color: ${baseColor}">${d.boatSource}</div>
                                <b>Event:</b> ${d.type || 'Fishing'}<br>
                                <b>Voyage ID:</b> ${d.seg_id}<br>
                                <b>Start:</b> ${d.dateObj.toLocaleString()}<br>
                                <b>End:</b> ${d.endDateObj.toLocaleString()}
                            </div>
                        `, { sticky: true }).addTo(targetLayer);
                    });
                } else {
                    // Draw ONLY the "Head" point (Animation Mode)
                    if (points.length > 0) {
                        const currentPos = points[points.length - 1]; 
                        L.circleMarker([+currentPos.lat, +currentPos.lon], {
                            radius: 6, fillColor: baseColor, color: "#fff", weight: 2, fillOpacity: 1
                        }).bindTooltip(`
                            <div class="custom-tooltip">
                                <div class="tooltip-title" style="border-color: ${baseColor}">${currentPos.boatSource}</div>
                                <b>Date:</b> ${currentPos.dateObj.toLocaleDateString()}<br>
                                <b>Voyage ID:</b> ${currentPos.seg_id}
                            </div>
                        `, { sticky: true }).addTo(targetLayer);
                    }
                }
            });
        });
    }

    // --- KRILL HEATMAP ---
    function renderKrillHeatmap() {
        krillHeatmapLayer.clearLayers();
        const startYear = parseInt(document.getElementById('krill-start-year').value);
        const endYear = parseInt(document.getElementById('krill-end-year').value);
        
        const filteredKrill = allKrillData.filter(d => d.yearNum >= startYear && d.yearNum <= endYear);
        document.getElementById('krill-count').innerText = `Displaying ${filteredKrill.length} krill data points`;
        
        if (filteredKrill.length === 0) return;

        const heatPoints = filteredKrill.map(d => [d.lat, d.lon]);
        
        L.heatLayer(heatPoints, {
            radius: 18, blur: 20, maxZoom: 6,
            gradient: { 0.3: '#74add1', 0.5: '#e0f3f8', 0.7: '#fee090', 1.0: '#f46d43' }
        }).addTo(krillHeatmapLayer);
    }

    // --- EVENT LISTENERS ---
    document.getElementById('apply-track-filter').addEventListener('click', renderTracks);
    document.getElementById('apply-krill-filter').addEventListener('click', renderKrillHeatmap);
    document.getElementById('play-animation').addEventListener('click', toggleAnimation);
</script>

</body>
</html>