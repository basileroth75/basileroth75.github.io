<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krill & Boat Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #map-wrapper {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border: none;
            border-radius: 0;
            overflow: hidden;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            z-index: 999; 
        }
        
        #map { width: 100%; height: 100%; z-index: 1; }

        .custom-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 6px 10px;
            color: #333;
            font-size: 12px;
            line-height: 1.4;
        }
        .custom-tooltip b { color: #555; }
        .tooltip-title { font-weight: bold; font-size: 13px; margin-bottom: 4px; border-bottom: 1px solid; padding-bottom: 2px;}

        #controls-panel { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 10px; 
            border-radius: 6px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            font-size: 11px; 
            z-index: 1000; 
            width: 240px; 
            max-height: 90%; 
            overflow-y: auto;
        }
        
        .legend-title { font-weight: bold; font-size: 12px; margin-bottom: 6px; border-bottom: 1px solid #ddd; padding-bottom: 4px;}
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; } 
        
        .legend-color { width: 12px; height: 12px; margin-right: 6px; border-radius: 2px; border: 1px solid #999; flex-shrink: 0;}
        .legend-line { width: 12px; height: 2px; margin-right: 6px; flex-shrink: 0;}
        
        .filter-section { margin-top: 10px; border-top: 1px solid #ddd; padding-top: 8px; }
        .input-group { display: flex; flex-direction: column; margin-top: 5px; gap: 4px; }
        .input-group input, .input-group select { padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; box-sizing: border-box;}
        .action-btn { margin-top: 5px; width: 100%; padding: 4px; background: #2c3e50; color: white; border: none; border-radius: 3px; cursor: pointer; transition: 0.2s; font-size: 11px;}
        .action-btn:hover { background: #34495e; }
        .count-text { margin-top: 4px; font-size: 0.9em; color: #666; font-style: italic;}
    </style>
</head>
<body>

<div id="map-wrapper">
    <div id="map"></div>

    <div id="controls-panel">
        <div class="legend-title">Map Layers & Legend</div>
        
        <div id="dynamic-zone-legend"></div>
        <hr style="border: 0; border-top: 1px solid #ddd; margin: 8px 0;">
        
        <div class="legend-item">
            <input type="checkbox" id="toggle-boat1" checked style="margin-right: 6px; cursor: pointer;">
            <div class="legend-line" style="background: #377eb8;"></div>
            <span>Boat 1</span>
        </div>
        <div class="legend-item">
            <input type="checkbox" id="toggle-boat2" checked style="margin-right: 6px; cursor: pointer;">
            <div class="legend-line" style="background: #e41a1c;"></div>
            <span>Boat 2</span>
        </div>

        <div class="legend-item" style="margin-top: 8px;">
            <div class="legend-color" style="background: linear-gradient(to right, #2b83ba, #abdda4, #fdae61, #d7191c); border: 1px solid #999;"></div>
            <span>Krill Density (Heatmap)</span>
        </div>

        <div class="filter-section">
            <strong>Filter Tracks:</strong>
            <div class="input-group">
                <label>Date From: <input type="date" id="start-date" value="2020-01-01"></label>
                <label>Date To: <input type="date" id="end-date"></label>
                
                <label>Month From: 
                    <select id="start-month">
                        <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                        <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                        <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                    </select>
                </label>
                <label>Month To: 
                    <select id="end-month">
                        <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                        <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                        <option value="9">October</option><option value="10">November</option><option value="11" selected>December</option>
                    </select>
                </label>

                <label>Max Speed (knots): <input type="number" id="max-speed" value="100" min="0" step="0.5"></label>
                <button id="apply-track-filter" class="action-btn">Apply Track Filter</button>
            </div>
            <div id="track-count" class="count-text"></div>
        </div>

        <div class="filter-section">
            <strong>Filter Krill by Year:</strong>
            <div class="input-group">
                <label>From: <input type="number" id="krill-start-year"></label>
                <label>To: <input type="number" id="krill-end-year"></label>
                <button id="apply-krill-filter" class="action-btn">Apply Krill Filter</button>
            </div>
            <div id="krill-count" class="count-text"></div>
        </div>
    </div>
</div>

<script>
    // --- IMPORTANT: CHANGE THIS TO MATCH YOUR NEW CSV COLUMN NAME ---
    const FORBIDDEN_COLUMN_NAME = "protected"; // <-- EDIT THIS LINE
    // ----------------------------------------------------------------

    // 1. Initialize Map
    const map = L.map('map', { zoomControl: false }).setView([-60, -55], 5);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 18
    }).addTo(map);

    const zonesLayer = L.layerGroup().addTo(map); // Combined Layer for Zones
    const tracksLayer = L.layerGroup().addTo(map);
    const krillHeatmapLayer = L.layerGroup().addTo(map);

    const overlayMaps = {
        "Protection Zones": zonesLayer,
        "ðŸš¢ Boat Tracks": tracksLayer,
        "ðŸŸ Krill Heatmap": krillHeatmapLayer
    };
    L.control.layers(null, overlayMaps, { collapsed: false, position: 'topright' }).addTo(map);

    let allTracksData = []; 
    let allKrillData = [];

  

    const tracksCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/ANTARTIC_ENDURANCE.csv";
    const tracks2CsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/SAGA_SEA(NOR).csv";
    const zonesCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/domaine1-Zone_de_protection_general.csv";
    const zonesSaisonCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/domaine1-Zone_de_protection_saison.csv";
    const krillCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/processed_krill.csv";



    Promise.all([
        d3.csv(tracksCsvUrl),
        d3.csv(tracks2CsvUrl).catch(() => []), 
        d3.dsv(";", zonesCsvUrl),
        d3.dsv(";", zonesSaisonCsvUrl),
        d3.csv(krillCsvUrl)
    ]).then(([tracks1Data, tracks2Data, zonesData, zonesSaisonData, krillData]) => {

        // --- ZONES & DYNAMIC LEGEND ---
        const allZonesData = [...zonesData, ...zonesSaisonData];
        
        // Find all unique forbidden periods in the combined datasets
        const uniquePeriods = Array.from(new Set(allZonesData.map(d => d[FORBIDDEN_COLUMN_NAME] || 'Not Specified')));
        
        // Create a color scale assigning a distinct color to each unique period
        const zoneColorScale = d3.scaleOrdinal(d3.schemeTableau10).domain(uniquePeriods);

        // Build the dynamic legend
        const legendContainer = document.getElementById('dynamic-zone-legend');
        uniquePeriods.forEach(period => {
            const color = zoneColorScale(period);
            const borderColor = d3.rgb(color).darker(0.5);
            legendContainer.innerHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${color}; opacity: 0.6; border-color: ${borderColor};"></div>
                    <span>Forbidden: ${period}</span>
                </div>
            `;
        });

        // Function to draw the zones using the dynamic colors
        function renderZoneGroup(data) {
            d3.group(data, d => d.zone_id).forEach((points, zoneId) => {
                points.sort((a, b) => +a.seq - +b.seq);
                const period = points[0][FORBIDDEN_COLUMN_NAME] || 'Not Specified';
                const fillColor = zoneColorScale(period);
                const borderColor = d3.rgb(fillColor).darker(0.5);
                const latlngs = points.map(p => [+p.lat, +p.lon]);

                L.polygon(latlngs, {
                    color: borderColor, fillColor: fillColor,
                    weight: 2, dashArray: '4, 4', fillOpacity: 0.4
                }).bindTooltip(`
                    <div class="custom-tooltip">
                        <div class="tooltip-title" style="border-color: ${borderColor}">Protection Zone</div>
                        <b>ID:</b> ${zoneId}<br>
                        <b>Protection periods:</b> ${period}
                    </div>
                `, { sticky: true }).addTo(zonesLayer);
            });
        }

        renderZoneGroup(zonesData);
        renderZoneGroup(zonesSaisonData);


        // --- TRACKS ---
        tracks1Data.forEach(d => { d.boatSource = "Boat 1"; d.dateObj = new Date(d.timestamp); });
        tracks2Data.forEach(d => { d.boatSource = "Boat 2"; d.dateObj = new Date(d.timestamp); });
        
        allTracksData = [...tracks1Data, ...tracks2Data];

        let maxDate = allTracksData.length > 0 ? d3.max(allTracksData, d => d.dateObj) : new Date();
        document.getElementById('end-date').value = maxDate.toISOString().split('T')[0];

        renderTracks(); 

        // --- KRILL ---
        let krillMinYear = 3000, krillMaxYear = 0;
        krillData.forEach(d => {
            d.yearNum = parseInt(d.year);
            d.lat = parseFloat(d.decimalLatitude);
            d.lon = parseFloat(d.decimalLongitude);
            d.quantity = parseFloat(d.organismQuantity);
            
            if (!isNaN(d.yearNum)) {
                if (d.yearNum < krillMinYear) krillMinYear = d.yearNum;
                if (d.yearNum > krillMaxYear) krillMaxYear = d.yearNum;
            }
        });
        
        allKrillData = krillData.filter(d => d.quantity > 0 && !isNaN(d.lat) && !isNaN(d.lon));
        document.getElementById('krill-start-year').value = krillMinYear;
        document.getElementById('krill-end-year').value = krillMaxYear;
        document.getElementById('krill-start-year').min = krillMinYear;
        document.getElementById('krill-end-year').max = krillMaxYear;

        renderKrillHeatmap(); 

    }).catch(error => {
        console.error("Error loading data:", error);
    });

    function renderTracks() {
        tracksLayer.clearLayers();
        
        // Parse basic filters
        const start = new Date(document.getElementById('start-date').value);
        const end = new Date(document.getElementById('end-date').value);
        end.setHours(23, 59, 59); 

        const showBoat1 = document.getElementById('toggle-boat1').checked;
        const showBoat2 = document.getElementById('toggle-boat2').checked;
        
        const maxSpeedInput = parseFloat(document.getElementById('max-speed').value);
        const maxSpeed = isNaN(maxSpeedInput) ? Infinity : maxSpeedInput;

        // Parse Month Filters
        const startMonth = parseInt(document.getElementById('start-month').value);
        const endMonth = parseInt(document.getElementById('end-month').value);

        const filteredData = allTracksData.filter(d => {
            if (!d.dateObj || isNaN(d.dateObj)) return false;

            const isRightTime = d.dateObj >= start && d.dateObj <= end;
            const isUnderSpeed = (+d.speed) <= maxSpeed;
            const isBoatVisible = (d.boatSource === "Boat 1" && showBoat1) || 
                                  (d.boatSource === "Boat 2" && showBoat2);
            
            // Month Span Logic
            const m = d.dateObj.getMonth();
            let isRightMonth = false;
            if (startMonth <= endMonth) {
                // Normal span (e.g. February to April -> 1 to 3)
                isRightMonth = (m >= startMonth && m <= endMonth);
            } else {
                // Wrap-around span (e.g. November to February -> 10 to 1)
                isRightMonth = (m >= startMonth || m <= endMonth);
            }

            return isRightTime && isUnderSpeed && isBoatVisible && isRightMonth;
        });

        document.getElementById('track-count').innerText = `Displaying ${filteredData.length} track points`;

        const tracksGrouped = d3.group(filteredData, d => d.boatSource, d => d.seg_id);
        const boatColorScale = d3.scaleOrdinal()
            .domain(["Boat 1", "Boat 2"])
            .range(["#377eb8", "#e41a1c"]); 

        tracksGrouped.forEach((segments, boatSource) => {
            const baseColor = boatColorScale(boatSource);

            segments.forEach((points, segId) => {
                points.sort((a, b) => a.dateObj - b.dateObj); 
                const latlngs = points.map(p => [+p.lat, +p.lon]);

                if (latlngs.length > 1) {
                    L.polyline(latlngs, { color: baseColor, weight: 1.5, opacity: 0.8 }).addTo(tracksLayer);
                }

                points.forEach(d => {
                    L.circleMarker([+d.lat, +d.lon], {
                        radius: 2, fillColor: baseColor, color: "#fff", weight: 0.5, fillOpacity: 1
                    }).bindTooltip(`
                        <div class="custom-tooltip">
                            <div class="tooltip-title" style="border-color: ${baseColor}">${d.boatSource}</div>
                            <b>Time:</b> ${d.dateObj.toLocaleString()}<br>
                            <b>Speed:</b> ${(+d.speed).toFixed(2)} knots
                        </div>
                    `, { sticky: true }).addTo(tracksLayer);
                });
            });
        });
    }

    function renderKrillHeatmap() {
        krillHeatmapLayer.clearLayers();
        const startYear = parseInt(document.getElementById('krill-start-year').value);
        const endYear = parseInt(document.getElementById('krill-end-year').value);
        const filteredKrill = allKrillData.filter(d => d.yearNum >= startYear && d.yearNum <= endYear);
        document.getElementById('krill-count').innerText = `Displaying ${filteredKrill.length} krill data points`;
        
        if (filteredKrill.length === 0) return;

        const quantities = filteredKrill.map(d => d.quantity).sort((a, b) => a - b);
        const maxVal = quantities[Math.floor(quantities.length * 0.98)] || 1; 

        const heatPoints = filteredKrill.map(d => [d.lat, d.lon, d.quantity]);
        
        L.heatLayer(heatPoints, {
            radius: 18, blur: 15, maxZoom: 6, max: maxVal,
            gradient: { 0.3: '#2b83ba', 0.5: '#abdda4', 0.8: '#fdae61', 1.0: '#d7191c' }
        }).addTo(krillHeatmapLayer);
    }

    // Event Listeners
    document.getElementById('apply-track-filter').addEventListener('click', renderTracks);
    document.getElementById('apply-krill-filter').addEventListener('click', renderKrillHeatmap);
    document.getElementById('toggle-boat1').addEventListener('change', renderTracks);
    document.getElementById('toggle-boat2').addEventListener('change', renderTracks);
</script>

</body>
</html>
