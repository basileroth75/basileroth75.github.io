<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krill & Boat Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        /* Reset body margins so there are no white borders around the screen */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        /* Fullscreen Wrapper Styling */
        #map-wrapper {
            position: fixed; /* Forces it to break out of other containers */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            border: none;
            border-radius: 0;
            overflow: hidden;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            z-index: 999; 
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
        }

        /* Tooltip Styling */
        .custom-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 6px 10px;
            color: #333;
            font-size: 12px;
            line-height: 1.4;
        }
        .custom-tooltip b { color: #555; }
        .tooltip-title { font-weight: bold; font-size: 13px; margin-bottom: 4px; border-bottom: 1px solid; padding-bottom: 2px;}

        /* Controls Panel Styling */
        #controls-panel { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 10px; 
            border-radius: 6px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            font-size: 11px; 
            z-index: 1000; 
            width: 220px; 
            max-height: 90%; 
            overflow-y: auto;
        }
        
        .legend-title { font-weight: bold; font-size: 12px; margin-bottom: 6px; border-bottom: 1px solid #ddd; padding-bottom: 4px;}
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; } 
        
        .legend-color { width: 12px; height: 12px; margin-right: 6px; border-radius: 2px; border: 1px solid #999; flex-shrink: 0;}
        .legend-line { width: 12px; height: 2px; margin-right: 6px; flex-shrink: 0;}
        
        .filter-section { margin-top: 10px; border-top: 1px solid #ddd; padding-top: 8px; }
        .input-group { display: flex; flex-direction: column; margin-top: 5px; gap: 4px; }
        .input-group input { padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; box-sizing: border-box;}
        .action-btn { margin-top: 5px; width: 100%; padding: 4px; background: #2c3e50; color: white; border: none; border-radius: 3px; cursor: pointer; transition: 0.2s; font-size: 11px;}
        .action-btn:hover { background: #34495e; }
        .count-text { margin-top: 4px; font-size: 0.9em; color: #666; font-style: italic;}
    </style>
</head>
<body>

<div id="map-wrapper">
    <div id="map"></div>

    <div id="controls-panel">
        <div class="legend-title">Map Layers & Legend</div>
        
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(141, 211, 199, 0.5); border-color: #6da39a;"></div>
            <span>General Protection Zones</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(251, 128, 114, 0.5); border-color: #d96f63; border-style: dashed;"></div>
            <span>Seasonal Protection Zones</span>
        </div>
        
        <div class="legend-item">
            <input type="checkbox" id="toggle-boat1" checked style="margin-right: 6px; cursor: pointer;">
            <div class="legend-line" style="background: #377eb8;"></div>
            <span>Boat 1</span>
        </div>
        <div class="legend-item">
            <input type="checkbox" id="toggle-boat2" checked style="margin-right: 6px; cursor: pointer;">
            <div class="legend-line" style="background: #e41a1c;"></div>
            <span>Boat 2</span>
        </div>

        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(to right, #2b83ba, #abdda4, #fdae61, #d7191c); border: 1px solid #999;"></div>
            <span>Krill Density (Heatmap)</span>
        </div>

        <div class="filter-section">
            <strong>Filter Tracks:</strong>
            <div class="input-group">
                <label>From: <input type="date" id="start-date" value="2023-01-01"></label>
                <label>To: <input type="date" id="end-date"></label>
                <label>Max Speed (knots): <input type="number" id="max-speed" value="100" min="0" step="0.5"></label>
                <button id="apply-track-filter" class="action-btn">Apply Track Filter</button>
            </div>
            <div id="track-count" class="count-text"></div>
        </div>

        <div class="filter-section">
            <strong>Filter Krill by Year:</strong>
            <div class="input-group">
                <label>From: <input type="number" id="krill-start-year"></label>
                <label>To: <input type="number" id="krill-end-year"></label>
                <button id="apply-krill-filter" class="action-btn">Apply Krill Filter</button>
            </div>
            <div id="krill-count" class="count-text"></div>
        </div>
    </div>
</div>

<script>
    // 1. Initialize Map
    const map = L.map('map', { zoomControl: false }).setView([-60, -55], 5);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 18
    }).addTo(map);

    const generalZonesLayer = L.layerGroup().addTo(map);
    const seasonalZonesLayer = L.layerGroup().addTo(map);
    const tracksLayer = L.layerGroup().addTo(map);
    const krillHeatmapLayer = L.layerGroup().addTo(map);

    const overlayMaps = {
        "General Zones": generalZonesLayer,
        "Seasonal Zones": seasonalZonesLayer,
        "ðŸš¢ Boat Tracks": tracksLayer,
        "ðŸŸ Krill Heatmap": krillHeatmapLayer
    };
    L.control.layers(null, overlayMaps, { collapsed: false, position: 'topright' }).addTo(map);

    let allTracksData = []; 
    let allKrillData = [];

    const colorGenFill = "#8dd3c7";
    const colorGenBorder = "#6da39a";
    const colorSeasFill = "#fb8072";
    const colorSeasBorder = "#d96f63";

    const tracksCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/ANTARTIC_ENDURANCE.csv";
    const tracks2CsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/SAGA_SEA(NOR).csv";
    const zonesCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/domaine1-Zone_de_protection_general.csv";
    const zonesSaisonCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/domaine1-Zone_de_protection_saison.csv";
    const krillCsvUrl = "https://raw.githubusercontent.com/basileroth75/data_viz/main/krill/processed_krill.csv";



    Promise.all([
        d3.csv(tracksCsvUrl),
        d3.csv(tracks2CsvUrl).catch(() => []), // Added .catch so the map doesn't break if the dummy URL fails
        d3.dsv(";", zonesCsvUrl),
        d3.dsv(";", zonesSaisonCsvUrl),
        d3.csv(krillCsvUrl)
    ]).then(([tracks1Data, tracks2Data, zonesData, zonesSaisonData, krillData]) => {

        // General Zones
        d3.group(zonesData, d => d.zone_id).forEach((points, zoneId) => {
            points.sort((a, b) => +a.seq - +b.seq);
            const latlngs = points.map(p => [+p.lat, +p.lon]);

            L.polygon(latlngs, {
                color: colorGenBorder, fillColor: colorGenFill,
                weight: 2, dashArray: '4, 4', fillOpacity: 0.5
            }).bindTooltip(`
                <div class="custom-tooltip">
                    <div class="tooltip-title" style="border-color: ${colorGenBorder}">General Protection Zone</div>
                    <b>ID:</b> ${zoneId}
                </div>
            `, { sticky: true }).addTo(generalZonesLayer);
        });

        // Seasonal Zones
        d3.group(zonesSaisonData, d => d.zone_id).forEach((points, zoneId) => {
            points.sort((a, b) => +a.seq - +b.seq);
            const latlngs = points.map(p => [+p.lat, +p.lon]);

            L.polygon(latlngs, {
                color: colorSeasBorder, fillColor: colorSeasFill,
                weight: 2.5, dashArray: '8, 5', fillOpacity: 0.5
            }).bindTooltip(`
                <div class="custom-tooltip">
                    <div class="tooltip-title" style="border-color: ${colorSeasBorder}">Seasonal Protection Zone</div>
                    <b>ID:</b> ${zoneId}
                </div>
            `, { sticky: true }).addTo(seasonalZonesLayer);
        });

        // Tracks - Combine and Flag Sources
        tracks1Data.forEach(d => { d.boatSource = "Boat 1"; d.dateObj = new Date(d.timestamp); });
        tracks2Data.forEach(d => { d.boatSource = "Boat 2"; d.dateObj = new Date(d.timestamp); });
        
        allTracksData = [...tracks1Data, ...tracks2Data];

        // Ensure max date works even if data is missing
        let maxDate = allTracksData.length > 0 ? d3.max(allTracksData, d => d.dateObj) : new Date();
        document.getElementById('end-date').value = maxDate.toISOString().split('T')[0];

        renderTracks(); 

        // Krill Heatmap
        let krillMinYear = 3000, krillMaxYear = 0;
        krillData.forEach(d => {
            d.yearNum = parseInt(d.year);
            d.lat = parseFloat(d.decimalLatitude);
            d.lon = parseFloat(d.decimalLongitude);
            d.quantity = parseFloat(d.organismQuantity);
            
            if (!isNaN(d.yearNum)) {
                if (d.yearNum < krillMinYear) krillMinYear = d.yearNum;
                if (d.yearNum > krillMaxYear) krillMaxYear = d.yearNum;
            }
        });
        
        allKrillData = krillData.filter(d => d.quantity > 0 && !isNaN(d.lat) && !isNaN(d.lon));

        document.getElementById('krill-start-year').value = krillMinYear;
        document.getElementById('krill-end-year').value = krillMaxYear;
        document.getElementById('krill-start-year').min = krillMinYear;
        document.getElementById('krill-end-year').max = krillMaxYear;

        renderKrillHeatmap(); 

    }).catch(error => {
        console.error("Error loading data:", error);
        alert("Error loading data. Check the browser console.");
    });

    function renderTracks() {
        tracksLayer.clearLayers();
        const start = new Date(document.getElementById('start-date').value);
        const end = new Date(document.getElementById('end-date').value);
        end.setHours(23, 59, 59); 

        const showBoat1 = document.getElementById('toggle-boat1').checked;
        const showBoat2 = document.getElementById('toggle-boat2').checked;
        
        const maxSpeedInput = parseFloat(document.getElementById('max-speed').value);
        const maxSpeed = isNaN(maxSpeedInput) ? Infinity : maxSpeedInput;

        const filteredData = allTracksData.filter(d => {
            const isRightTime = d.dateObj >= start && d.dateObj <= end;
            const isUnderSpeed = (+d.speed) <= maxSpeed;
            const isBoatVisible = (d.boatSource === "Boat 1" && showBoat1) || 
                                  (d.boatSource === "Boat 2" && showBoat2);
            return isRightTime && isUnderSpeed && isBoatVisible;
        });

        document.getElementById('track-count').innerText = `Displaying ${filteredData.length} track points`;

        const tracksGrouped = d3.group(filteredData, d => d.boatSource, d => d.seg_id);
        const boatColorScale = d3.scaleOrdinal()
            .domain(["Boat 1", "Boat 2"])
            .range(["#377eb8", "#e41a1c"]); 

        tracksGrouped.forEach((segments, boatSource) => {
            const baseColor = boatColorScale(boatSource);

            segments.forEach((points, segId) => {
                points.sort((a, b) => a.dateObj - b.dateObj); 
                const latlngs = points.map(p => [+p.lat, +p.lon]);

                if (latlngs.length > 1) {
                    L.polyline(latlngs, { color: baseColor, weight: 1.5, opacity: 0.8 }).addTo(tracksLayer);
                }

                points.forEach(d => {
                    L.circleMarker([+d.lat, +d.lon], {
                        radius: 2, fillColor: baseColor, color: "#fff", weight: 0.5, fillOpacity: 1
                    }).bindTooltip(`
                        <div class="custom-tooltip">
                            <div class="tooltip-title" style="border-color: ${baseColor}">${d.boatSource}</div>
                            <b>Time:</b> ${d.dateObj.toLocaleString()}<br>
                            <b>Speed:</b> ${(+d.speed).toFixed(2)} knots<br>
                            <b>Lat/Lon:</b> ${(+d.lat).toFixed(4)}, ${(+d.lon).toFixed(4)}
                        </div>
                    `, { sticky: true }).addTo(tracksLayer);
                });
            });
        });
    }

    function renderKrillHeatmap() {
        krillHeatmapLayer.clearLayers();
        
        const startYear = parseInt(document.getElementById('krill-start-year').value);
        const endYear = parseInt(document.getElementById('krill-end-year').value);
        
        const filteredKrill = allKrillData.filter(d => d.yearNum >= startYear && d.yearNum <= endYear);
        document.getElementById('krill-count').innerText = `Displaying ${filteredKrill.length} krill data points`;
        
        if (filteredKrill.length === 0) return;

        const quantities = filteredKrill.map(d => d.quantity).sort((a, b) => a - b);
        const maxVal = quantities[Math.floor(quantities.length * 0.98)] || 1; 

        const heatPoints = filteredKrill.map(d => [d.lat, d.lon, d.quantity]);
        
        L.heatLayer(heatPoints, {
            radius: 18, blur: 15, maxZoom: 6, max: maxVal,
            gradient: { 0.3: '#2b83ba', 0.5: '#abdda4', 0.8: '#fdae61', 1.0: '#d7191c' }
        }).addTo(krillHeatmapLayer);
    }

    // Event Listeners
    document.getElementById('apply-track-filter').addEventListener('click', renderTracks);
    document.getElementById('apply-krill-filter').addEventListener('click', renderKrillHeatmap);
    document.getElementById('toggle-boat1').addEventListener('change', renderTracks);
    document.getElementById('toggle-boat2').addEventListener('change', renderTracks);
</script>

</body>
</html>